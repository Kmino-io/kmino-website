---
import Logo from "~/assets/logo.svg";
import CTA from "./CTA";
import { Icon } from "astro-icon/components";
import { ClientRouter } from "astro:transitions";

interface Props {
  showNav?: boolean;
}

const currentURL = Astro.url;
const { showNav = true } = Astro.props;
---

<script is:inline>
  document.addEventListener("DOMContentLoaded", () => {
    // Move the menu overlay to the end of <body> for portal-like behavior
    const menuOverlay = document.getElementById("mobile-menu-overlay");
    if (menuOverlay && menuOverlay.parentNode !== document.body) {
      document.body.appendChild(menuOverlay);
    }

    // Helper: get hash from href (supports /, /#faq, /somepage/#faq)
    function getHashFromHref(href) {
      const hashIndex = href.indexOf("#");
      if (hashIndex === -1) return null;
      return href.slice(hashIndex + 1);
    }

    // Smooth scroll for all anchor links with hashes
    document.querySelectorAll('a[href*="#"]').forEach((link) => {
      link.addEventListener("click", function (e) {
        const href = this.getAttribute("href");
        const hash = getHashFromHref(href);
        if (!hash) return;

        // Only smooth scroll if the hash target is on the current page
        // (i.e. href starts with "/" or current pathname)
        const isSamePage =
          href.startsWith("/") ||
          href.startsWith(window.location.pathname) ||
          href.startsWith(
            `${window.location.origin}${window.location.pathname}`,
          );

        const target = document.getElementById(hash);
        if (target && isSamePage) {
          e.preventDefault();
          target.scrollIntoView({ behavior: "smooth" });
          history.replaceState(
            null,
            null,
            `${window.location.pathname}#${hash}`,
          );
        }

        if (menuOverlay && menuOverlay.classList.contains("open")) {
          menuOverlay.classList.remove("open");
        }
      });
    });

    menuOverlay?.querySelectorAll('a[href^="/"]').forEach((link) => {
      link.addEventListener("click", () => {
        menuOverlay.classList.remove("open");
      });
    });

    const menuBtn = document.getElementById("mobile-menu-btn");

    if (menuBtn && menuOverlay) {
      menuBtn.addEventListener("click", () => {
        menuOverlay.classList.add("open");
      });
    }

    menuOverlay.addEventListener("click", (e) => {
      if (e.target === menuOverlay) {
        menuOverlay.classList.remove("open");
      }
    });
  });
</script>

<style is:global>
  #mobile-menu-overlay {
    position: fixed;
    inset: 0;
    z-index: 50;
    display: flex;
    flex-direction: row;
    align-items: stretch;
    justify-content: flex-end;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
  }

  #mobile-menu-overlay.open {
    opacity: 1;
    pointer-events: auto;
  }

  #mobile-menu-overlay::before {
    content: "";
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
    z-index: 0;
    transition: background 0.2s;
  }

  .mobile-menu-panel {
    position: relative;
    z-index: 1;
    height: 100%;
    max-width: 248px;
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: space-between;
    background: var(--color-primary);
    transform: translateX(100%);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  #mobile-menu-overlay.open .mobile-menu-panel {
    transform: translateX(0);
    z-index: 50;
  }
</style>

<nav class="bg-primary py-4 text-white md:min-h-[80px] md:py-8">
  <div
    class="mx-auto flex max-w-[1240px] items-center justify-between px-4 lg:px-0"
  >
    <div>
      <a href="/#">
        <Logo />
      </a>
    </div>

    <div class="hidden gap-[42px] lg:flex">
      {
        !showNav ? (
          <>
            <a href={`${currentURL.pathname}/#offer`}>Services</a>
            <a href={`${currentURL.pathname}/#projects`}>Clients</a>
            <a href={`${currentURL.pathname}/#faq`}>FAQ</a>
          </>
        ) : (
          <>
            <a href="/#what-we-do">What We Do</a>
            <a href="/#how-we-work">How We Work</a>
            <a href="/#projects">Projects</a>
            <a href="/#about-us">About Us</a>
            <a
              href="/blog"
              class={
                currentURL.pathname.includes("/blog")
                  ? "font-semibold underline"
                  : ""
              }
            >
              Blog
            </a>
          </>
        )
      }
    </div>

    <div class="hidden lg:flex">
      <CTA href="https://calendar.app.google/bptKpG7DXXLZve3r5"
        >Talk to Our Team</CTA
      >
    </div>

    <div class="lg:hidden">
      <button id="mobile-menu-btn" class="flex">
        <Icon name="ri:menu-fill" size={22} />
      </button>
    </div>
  </div>
</nav>

<ClientRouter />
